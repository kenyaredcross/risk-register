import{D as de,o as n,e as a,f as t,u as z,x as r,y as m,v as V,F as g,C as f,j as C,E as y,g as K,m as F,t as p,n as ue,G as Q,A as ce,r as c,c as q}from"./vue-vendor-DORe5Ms0.js";import{a as w}from"./index-CtnbHJYv.js";const pe={class:"animate-fade-in"},me={class:"mb-6"},ve={class:"card"},be={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},ge={class:"relative"},fe={key:0,class:"absolute z-10 mt-1 w-full bg-white border border-light-border rounded-lg shadow-lg max-h-60 overflow-auto"},xe=["onMousedown"],ke={key:0,class:"px-4 py-3 text-sm text-medium-gray text-center"},ye=["value"],we=["disabled"],_e=["value"],he=["value"],je=["value"],Ce={class:"card"},Pe={class:"card"},Re={key:0,class:"text-sm text-medium-gray text-center py-4"},Ue={key:1,class:"space-y-3"},Me=["onUpdate:modelValue"],Ve=["onClick"],qe={class:"card"},Ae={key:0,class:"text-sm text-medium-gray text-center py-4"},De={key:1,class:"space-y-3"},Se=["onUpdate:modelValue"],Ne=["onClick"],Be={class:"card"},Ee={key:0,class:"text-sm text-medium-gray text-center py-4"},Fe={key:1,class:"space-y-4"},Le=["onClick"],Oe={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},$e={class:"md:col-span-2"},Te=["onUpdate:modelValue"],He=["onUpdate:modelValue"],Ie=["onUpdate:modelValue"],ze={class:"card"},Ke={class:"grid grid-cols-1 md:grid-cols-2 gap-6"},Qe={class:"flex items-center space-x-3"},Je={class:"text-2xl font-bold text-charcoal w-8 text-center"},We={class:"flex items-center space-x-3"},Ge={class:"text-2xl font-bold text-charcoal w-8 text-center"},Xe={class:"md:col-span-2 bg-light-gray rounded-lg p-4"},Ye={class:"card"},Ze={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},et={class:"card"},tt={key:0,class:"card bg-red-50 border border-red-200"},ot={class:"text-sm text-red-700"},st={class:"flex justify-end space-x-3"},lt=["disabled"],nt={class:"px-6 py-4 space-y-4"},at={key:0,class:"bg-red-50 border border-red-200 rounded-lg p-3"},it={class:"text-sm text-red-700"},rt={class:"px-6 py-4 border-t border-light-border flex justify-end space-x-3"},dt=["disabled"],mt={__name:"RiskCreate",setup(ut){const A=ce(),P=c(!1),_=c(""),L=c([]),R=c([]),O=c([]),$=c([]),T=c([]),h=c(""),j=c(!1),J=c(""),D=c(!1),x=c(""),k=c(""),U=c(!1),b=c(""),s=c({project:"",department:"",unit:"",region:"",risk_category:"",risk_owner:"",risk_description:"",possible_causes:[],effects:[],mitigating_actions:[],likelihood:3,impact:3,review_frequency:"",timeline:"",remarks:""}),S=q(()=>s.value.likelihood*s.value.impact),W=q(()=>{const l=S.value;return l>=15?"Critical":l>=10?"High":l>=5?"Medium":"Low"}),G=q(()=>s.value.department?$.value.filter(l=>l.department===s.value.department):[]),H=q(()=>{if(!h.value.trim())return R.value;const l=h.value.toLowerCase();return R.value.filter(e=>e.project_name.toLowerCase().includes(l)||e.name.toLowerCase().includes(l))}),X=l=>l>=15?"text-red-primary":l>=10?"text-orange-600":l>=5?"text-yellow-600":"text-green-600",Y=()=>{s.value.possible_causes.push({cause_description:""})},Z=l=>{s.value.possible_causes.splice(l,1)},ee=()=>{s.value.effects.push({consequence_description:""})},te=l=>{s.value.effects.splice(l,1)},oe=()=>{s.value.mitigating_actions.push({action_description:"",responsible_person:"",deadline:"",status:"Pending"})},se=l=>{s.value.mitigating_actions.splice(l,1)},I=l=>{s.value.project=l.name,J.value=l.project_name,h.value=l.project_name,j.value=!1},le=()=>{setTimeout(()=>{j.value=!1},200)},ne=()=>{j.value=!1,D.value=!0,x.value="",k.value="",b.value=""},N=()=>{D.value=!1,x.value="",k.value="",b.value=""},B=async()=>{var l,e,o,d;if(!x.value.trim()){b.value="Project name is required";return}if(!k.value.trim()){b.value="Project code is required";return}U.value=!0,b.value="";try{const i={doctype:"Project",project_name:x.value.trim(),project_code:k.value.trim()},v=await w.post("/api/resource/Project",i);if(v.data&&v.data.data){const M={name:v.data.data.name,project_name:v.data.data.project_name};R.value.push(M),I(M),N()}else b.value="Failed to create project. Please try again."}catch(i){const v=((e=(l=i.response)==null?void 0:l.data)==null?void 0:e.message)||((d=(o=i.response)==null?void 0:o.data)==null?void 0:d.exc)||"An error occurred while creating the project.";v.includes("Duplicate")||v.includes("already exists")?b.value="A project with this code already exists. Please use a unique project code.":b.value=v,console.error("Error creating project:",i)}finally{U.value=!1}},ae=async()=>{try{const e=(await w.get("/api/method/krcs_risk.krcs_risk_management.doctype.program_risk_register.api.get_departments")).data.message||[];L.value=e,$.value=e.flatMap(v=>v.units||[]);const o=await w.get("/api/resource/Project",{params:{fields:JSON.stringify(["name","project_name"]),limit_page_length:999}});R.value=o.data.data||[];const d=await w.get("/api/resource/Region",{params:{fields:JSON.stringify(["name","region_name"]),limit_page_length:999}});O.value=d.data.data||[];const i=await w.get("/api/method/krcs_risk.krcs_risk_management.doctype.program_risk_register.api.get_users");T.value=i.data.message||[]}catch(l){console.error("Failed to load master data",l)}},ie=async()=>{var l,e,o,d;P.value=!0,_.value="";try{const i=s.value.possible_causes.filter(u=>u.cause_description&&u.cause_description.trim()).map(u=>({doctype:"Possible Cause",cause_description:u.cause_description.trim()})),v=s.value.effects.filter(u=>u.consequence_description&&u.consequence_description.trim()).map(u=>({doctype:"Risk Consequence",consequence_description:u.consequence_description.trim()})),M=s.value.mitigating_actions.filter(u=>u.action_description&&u.action_description.trim()).map(u=>({doctype:"Mitigating Action",action_description:u.action_description.trim(),responsible_person:u.responsible_person||null,deadline:u.deadline||null,status:"Pending"})),re={doctype:"Program Risk Register",project:s.value.project||null,department:s.value.department,unit:s.value.unit||null,region:s.value.region||null,risk_category:s.value.risk_category,risk_owner:s.value.risk_owner||null,risk_description:s.value.risk_description,possible_causes:i,effects:v,mitigating_actions:M,likelihood:s.value.likelihood,impact:s.value.impact,review_frequency:s.value.review_frequency||null,timeline:s.value.timeline||null,remarks:s.value.remarks||null,status:"Draft"},E=await w.post("/api/resource/Program Risk Register",re);E.data&&E.data.data?A.push(`/risk/${E.data.data.name}`):_.value="Failed to create risk. Please try again."}catch(i){_.value=((e=(l=i.response)==null?void 0:l.data)==null?void 0:e.message)||((d=(o=i.response)==null?void 0:o.data)==null?void 0:d.exc)||"An error occurred while creating the risk.",console.error("Error creating risk:",i)}finally{P.value=!1}};return de(()=>{ae()}),(l,e)=>(n(),a("div",pe,[t("div",me,[t("button",{onClick:e[0]||(e[0]=o=>z(A).back()),class:"text-medium-gray hover:text-charcoal mb-4 flex items-center space-x-2"},[...e[18]||(e[18]=[t("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 19l-7-7 7-7"})],-1),t("span",null,"Back",-1)])]),e[19]||(e[19]=t("h1",{class:"text-3xl font-bold text-charcoal mb-2"},"Create New Risk",-1)),e[20]||(e[20]=t("p",{class:"text-medium-gray"},"Submit a new risk to the register",-1))]),t("form",{onSubmit:V(ie,["prevent"]),class:"space-y-6"},[t("div",ve,[e[33]||(e[33]=t("h2",{class:"card-header"},"Basic Information",-1)),t("div",be,[t("div",ge,[e[22]||(e[22]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Project",-1)),r(t("input",{"onUpdate:modelValue":e[1]||(e[1]=o=>h.value=o),onFocus:e[2]||(e[2]=o=>j.value=!0),onBlur:le,type:"text",class:"input w-full",placeholder:"Search or select project..."},null,544),[[m,h.value]]),j.value?(n(),a("div",fe,[t("button",{type:"button",onMousedown:V(ne,["prevent"]),class:"w-full text-left px-4 py-2 text-sm hover:bg-light-gray flex items-center space-x-2 text-red-primary font-medium border-b border-light-border"},[...e[21]||(e[21]=[t("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),t("span",null,"Create New Project",-1)])],32),(n(!0),a(g,null,f(H.value,o=>(n(),a("button",{key:o.name,type:"button",onMousedown:V(d=>I(o),["prevent"]),class:"w-full text-left px-4 py-2 text-sm hover:bg-light-gray"},p(o.project_name),41,xe))),128)),H.value.length===0?(n(),a("div",ke," No projects found ")):C("",!0)])):C("",!0)]),t("div",null,[e[24]||(e[24]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Department *",-1)),r(t("select",{"onUpdate:modelValue":e[3]||(e[3]=o=>s.value.department=o),required:"",class:"input w-full"},[e[23]||(e[23]=t("option",{value:""},"Select Department",-1)),(n(!0),a(g,null,f(L.value,o=>(n(),a("option",{key:o.name,value:o.name},p(o.department_name),9,ye))),128))],512),[[y,s.value.department]])]),t("div",null,[e[26]||(e[26]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Unit",-1)),r(t("select",{"onUpdate:modelValue":e[4]||(e[4]=o=>s.value.unit=o),class:"input w-full",disabled:!s.value.department},[e[25]||(e[25]=t("option",{value:""},"Select Unit",-1)),(n(!0),a(g,null,f(G.value,o=>(n(),a("option",{key:o.name,value:o.name},p(o.unit_name),9,_e))),128))],8,we),[[y,s.value.unit]])]),t("div",null,[e[28]||(e[28]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Region",-1)),r(t("select",{"onUpdate:modelValue":e[5]||(e[5]=o=>s.value.region=o),class:"input w-full"},[e[27]||(e[27]=t("option",{value:""},"Select Region",-1)),(n(!0),a(g,null,f(O.value,o=>(n(),a("option",{key:o.name,value:o.name},p(o.region_name),9,he))),128))],512),[[y,s.value.region]])]),t("div",null,[e[30]||(e[30]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Risk Category *",-1)),r(t("select",{"onUpdate:modelValue":e[6]||(e[6]=o=>s.value.risk_category=o),required:"",class:"input w-full"},[...e[29]||(e[29]=[K('<option value="">Select Category</option><option value="Financial">Financial</option><option value="Operational">Operational</option><option value="Strategic">Strategic</option><option value="Compliance">Compliance</option><option value="Reputational">Reputational</option><option value="Technology">Technology</option>',7)])],512),[[y,s.value.risk_category]])]),t("div",null,[e[32]||(e[32]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Risk Owner",-1)),r(t("select",{"onUpdate:modelValue":e[7]||(e[7]=o=>s.value.risk_owner=o),class:"input w-full"},[e[31]||(e[31]=t("option",{value:""},"Select Risk Owner",-1)),(n(!0),a(g,null,f(T.value,o=>(n(),a("option",{key:o.name,value:o.name},p(o.full_name)+" ("+p(o.roles_display)+") ",9,je))),128))],512),[[y,s.value.risk_owner]])])])]),t("div",Ce,[e[35]||(e[35]=t("h2",{class:"card-header"},"Risk Description",-1)),t("div",null,[e[34]||(e[34]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Risk Description *",-1)),r(t("textarea",{"onUpdate:modelValue":e[8]||(e[8]=o=>s.value.risk_description=o),required:"",rows:"4",class:"input w-full",placeholder:"Describe the risk..."},null,512),[[m,s.value.risk_description]])])]),t("div",Pe,[t("div",{class:"flex items-center justify-between mb-4"},[e[37]||(e[37]=t("h2",{class:"text-lg font-bold text-charcoal"},"Possible Causes",-1)),t("button",{type:"button",onClick:Y,class:"btn btn-outline btn-sm"},[...e[36]||(e[36]=[t("svg",{class:"w-4 h-4 inline mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),F(" Add Cause ",-1)])])]),s.value.possible_causes.length===0?(n(),a("div",Re,' No causes added yet. Click "Add Cause" to add one. ')):(n(),a("div",Ue,[(n(!0),a(g,null,f(s.value.possible_causes,(o,d)=>(n(),a("div",{key:d,class:"flex gap-2"},[r(t("textarea",{"onUpdate:modelValue":i=>o.cause_description=i,rows:"2",class:"input w-full",placeholder:"Describe a possible cause..."},null,8,Me),[[m,o.cause_description]]),t("button",{type:"button",onClick:i=>Z(d),class:"text-red-primary hover:text-red-600"},[...e[38]||(e[38]=[t("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])],8,Ve)]))),128))]))]),t("div",qe,[t("div",{class:"flex items-center justify-between mb-4"},[e[40]||(e[40]=t("h2",{class:"text-lg font-bold text-charcoal"},"Effects / Consequences",-1)),t("button",{type:"button",onClick:ee,class:"btn btn-outline btn-sm"},[...e[39]||(e[39]=[t("svg",{class:"w-4 h-4 inline mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),F(" Add Effect ",-1)])])]),s.value.effects.length===0?(n(),a("div",Ae,' No effects added yet. Click "Add Effect" to add one. ')):(n(),a("div",De,[(n(!0),a(g,null,f(s.value.effects,(o,d)=>(n(),a("div",{key:d,class:"flex gap-2"},[r(t("textarea",{"onUpdate:modelValue":i=>o.consequence_description=i,rows:"2",class:"input w-full",placeholder:"Describe a possible effect/consequence..."},null,8,Se),[[m,o.consequence_description]]),t("button",{type:"button",onClick:i=>te(d),class:"text-red-primary hover:text-red-600"},[...e[41]||(e[41]=[t("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])],8,Ne)]))),128))]))]),t("div",Be,[t("div",{class:"flex items-center justify-between mb-4"},[e[43]||(e[43]=t("h2",{class:"text-lg font-bold text-charcoal"},"Mitigating Actions",-1)),t("button",{type:"button",onClick:oe,class:"btn btn-outline btn-sm"},[...e[42]||(e[42]=[t("svg",{class:"w-4 h-4 inline mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),F(" Add Action ",-1)])])]),s.value.mitigating_actions.length===0?(n(),a("div",Ee,' No mitigating actions added yet. Click "Add Action" to add one. ')):(n(),a("div",Fe,[(n(!0),a(g,null,f(s.value.mitigating_actions,(o,d)=>(n(),a("div",{key:d,class:"border border-light-border rounded-lg p-4 relative"},[t("button",{type:"button",onClick:i=>se(d),class:"absolute top-2 right-2 text-red-primary hover:text-red-600"},[...e[44]||(e[44]=[t("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])],8,Le),t("div",Oe,[t("div",$e,[e[45]||(e[45]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Action Description *",-1)),r(t("textarea",{"onUpdate:modelValue":i=>o.action_description=i,rows:"2",class:"input w-full",placeholder:"Describe the mitigating action..."},null,8,Te),[[m,o.action_description]])]),t("div",null,[e[46]||(e[46]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Responsible Person",-1)),r(t("input",{"onUpdate:modelValue":i=>o.responsible_person=i,type:"text",class:"input w-full",placeholder:"Person responsible"},null,8,He),[[m,o.responsible_person]])]),t("div",null,[e[47]||(e[47]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Deadline",-1)),r(t("input",{"onUpdate:modelValue":i=>o.deadline=i,type:"date",class:"input w-full"},null,8,Ie),[[m,o.deadline]])])])]))),128))]))]),t("div",ze,[e[53]||(e[53]=t("h2",{class:"card-header"},"Risk Assessment",-1)),t("div",Ke,[t("div",null,[e[48]||(e[48]=t("label",{class:"block text-sm font-medium text-charcoal mb-2"},"Likelihood (1-5) *",-1)),t("div",Qe,[r(t("input",{"onUpdate:modelValue":e[9]||(e[9]=o=>s.value.likelihood=o),type:"range",min:"1",max:"5",required:"",class:"flex-1"},null,512),[[m,s.value.likelihood,void 0,{number:!0}]]),t("span",Je,p(s.value.likelihood),1)]),e[49]||(e[49]=t("div",{class:"text-xs text-medium-gray mt-1"},"1 = Very Unlikely, 5 = Very Likely",-1))]),t("div",null,[e[50]||(e[50]=t("label",{class:"block text-sm font-medium text-charcoal mb-2"},"Impact (1-5) *",-1)),t("div",We,[r(t("input",{"onUpdate:modelValue":e[10]||(e[10]=o=>s.value.impact=o),type:"range",min:"1",max:"5",required:"",class:"flex-1"},null,512),[[m,s.value.impact,void 0,{number:!0}]]),t("span",Ge,p(s.value.impact),1)]),e[51]||(e[51]=t("div",{class:"text-xs text-medium-gray mt-1"},"1 = Negligible, 5 = Catastrophic",-1))]),t("div",Xe,[e[52]||(e[52]=t("div",{class:"text-sm text-medium-gray mb-1"},"Overall Rating (Auto-calculated)",-1)),t("div",{class:ue(["text-3xl font-bold",X(S.value)])},p(S.value)+" â€” "+p(W.value),3)])])]),t("div",Ye,[e[57]||(e[57]=t("h2",{class:"card-header"},"Review Schedule",-1)),t("div",Ze,[t("div",null,[e[55]||(e[55]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Review Frequency",-1)),r(t("select",{"onUpdate:modelValue":e[11]||(e[11]=o=>s.value.review_frequency=o),class:"input w-full"},[...e[54]||(e[54]=[K('<option value="">Not Scheduled</option><option value="Daily">Daily</option><option value="Weekly">Weekly</option><option value="Fortnightly">Fortnightly</option><option value="Monthly">Monthly</option><option value="Quarterly">Quarterly</option><option value="Semi-Annual">Semi-Annual</option><option value="Annual">Annual</option>',8)])],512),[[y,s.value.review_frequency]])]),t("div",null,[e[56]||(e[56]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Timeline",-1)),r(t("input",{"onUpdate:modelValue":e[12]||(e[12]=o=>s.value.timeline=o),type:"text",class:"input w-full",placeholder:"e.g., Q1 2026"},null,512),[[m,s.value.timeline]])])])]),t("div",et,[e[59]||(e[59]=t("h2",{class:"card-header"},"Additional Information",-1)),t("div",null,[e[58]||(e[58]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Remarks",-1)),r(t("textarea",{"onUpdate:modelValue":e[13]||(e[13]=o=>s.value.remarks=o),rows:"2",class:"input w-full",placeholder:"Any additional notes..."},null,512),[[m,s.value.remarks]])])]),_.value?(n(),a("div",tt,[t("p",ot,p(_.value),1)])):C("",!0),t("div",st,[t("button",{type:"button",onClick:e[14]||(e[14]=o=>z(A).back()),class:"btn btn-outline"},"Cancel"),t("button",{type:"submit",disabled:P.value,class:"btn btn-primary"},p(P.value?"Creating...":"Create Risk"),9,lt)])],32),D.value?(n(),a("div",{key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:N},[t("div",{class:"bg-white rounded-lg shadow-xl max-w-md w-full mx-4",onClick:e[17]||(e[17]=V(()=>{},["stop"]))},[e[63]||(e[63]=t("div",{class:"px-6 py-4 border-b border-light-border"},[t("h3",{class:"text-xl font-bold text-charcoal"},"Create New Project")],-1)),t("div",nt,[t("div",null,[e[60]||(e[60]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Project Name *",-1)),r(t("input",{"onUpdate:modelValue":e[15]||(e[15]=o=>x.value=o),type:"text",class:"input w-full",placeholder:"Enter project name",onKeydown:Q(B,["enter"])},null,544),[[m,x.value]])]),t("div",null,[e[61]||(e[61]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Project Code (ID) *",-1)),r(t("input",{"onUpdate:modelValue":e[16]||(e[16]=o=>k.value=o),type:"text",class:"input w-full",placeholder:"Unique project code/ID",onKeydown:Q(B,["enter"])},null,544),[[m,k.value]]),e[62]||(e[62]=t("p",{class:"text-xs text-medium-gray mt-1"},"Must be unique identifier for this project",-1))]),b.value?(n(),a("div",at,[t("p",it,p(b.value),1)])):C("",!0)]),t("div",rt,[t("button",{type:"button",onClick:N,class:"btn btn-outline"},"Cancel"),t("button",{type:"button",onClick:B,disabled:U.value,class:"btn btn-primary"},p(U.value?"Creating...":"Create Project"),9,dt)])])])):C("",!0)]))}};export{mt as default};
