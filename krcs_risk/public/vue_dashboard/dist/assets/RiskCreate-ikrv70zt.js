import{D as ne,o as a,e as n,f as t,u as H,x as i,y as v,v as U,F as b,C as x,j as _,E as y,g as z,m as K,t as c,n as re,G as Q,A as ie,r as u,c as V}from"./vue-vendor-DORe5Ms0.js";import{a as w}from"./index-Dy9jsXtf.js";const ue={class:"animate-fade-in"},de={class:"mb-6"},ce={class:"card"},pe={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},me={class:"relative"},ve={key:0,class:"absolute z-10 mt-1 w-full bg-white border border-light-border rounded-lg shadow-lg max-h-60 overflow-auto"},fe=["onMousedown"],be={key:0,class:"px-4 py-3 text-sm text-medium-gray text-center"},xe=["value"],ke=["disabled"],ge=["value"],ye=["value"],we=["value"],je={class:"card"},Ce={class:"card"},he={key:0,class:"text-sm text-medium-gray text-center py-4"},_e={key:1,class:"space-y-3"},Pe=["onUpdate:modelValue"],Re=["onClick"],qe={class:"card"},Me={key:0,class:"text-sm text-medium-gray text-center py-4"},Ue={key:1,class:"space-y-3"},Ve=["onUpdate:modelValue"],De=["onClick"],Se={class:"card"},Ne={class:"grid grid-cols-1 md:grid-cols-2 gap-6"},Ae={class:"flex items-center space-x-3"},Be={class:"text-2xl font-bold text-charcoal w-8 text-center"},Ee={class:"flex items-center space-x-3"},Fe={class:"text-2xl font-bold text-charcoal w-8 text-center"},Le={class:"md:col-span-2 bg-light-gray rounded-lg p-4"},Oe={class:"card"},$e={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Te={class:"card"},Ie={key:0,class:"card bg-red-50 border border-red-200"},He={class:"text-sm text-red-700"},ze={class:"flex justify-end space-x-3"},Ke=["disabled"],Qe={class:"px-6 py-4 space-y-4"},Je={key:0,class:"bg-red-50 border border-red-200 rounded-lg p-3"},We={class:"text-sm text-red-700"},Ge={class:"px-6 py-4 border-t border-light-border flex justify-end space-x-3"},Xe=["disabled"],tt={__name:"RiskCreate",setup(Ye){const D=ie(),P=u(!1),j=u(""),F=u([]),R=u([]),L=u([]),O=u([]),$=u([]),C=u(""),h=u(!1),J=u(""),S=u(!1),k=u(""),g=u(""),q=u(!1),m=u(""),s=u({project:"",department:"",unit:"",region:"",risk_category:"",risk_owner:"",risk_description:"",possible_causes:[],effects:[],likelihood:3,impact:3,review_frequency:"",timeline:"",remarks:""}),N=V(()=>s.value.likelihood*s.value.impact),W=V(()=>{const o=N.value;return o>=15?"Critical":o>=10?"High":o>=5?"Medium":"Low"}),G=V(()=>s.value.department?O.value.filter(o=>o.department===s.value.department):[]),T=V(()=>{if(!C.value.trim())return R.value;const o=C.value.toLowerCase();return R.value.filter(e=>e.project_name.toLowerCase().includes(o)||e.name.toLowerCase().includes(o))}),X=o=>o>=15?"text-red-primary":o>=10?"text-orange-600":o>=5?"text-yellow-600":"text-green-600",Y=()=>{s.value.possible_causes.push({cause_description:""})},Z=o=>{s.value.possible_causes.splice(o,1)},ee=()=>{s.value.effects.push({consequence_description:""})},te=o=>{s.value.effects.splice(o,1)},I=o=>{s.value.project=o.name,J.value=o.project_name,C.value=o.project_name,h.value=!1},le=()=>{setTimeout(()=>{h.value=!1},200)},se=()=>{h.value=!1,S.value=!0,k.value="",g.value="",m.value=""},A=()=>{S.value=!1,k.value="",g.value="",m.value=""},B=async()=>{var o,e,l,d;if(!k.value.trim()){m.value="Project name is required";return}if(!g.value.trim()){m.value="Project code is required";return}q.value=!0,m.value="";try{const r={doctype:"Project",project_name:k.value.trim(),project_code:g.value.trim()},p=await w.post("/api/resource/Project",r);if(p.data&&p.data.data){const M={name:p.data.data.name,project_name:p.data.data.project_name};R.value.push(M),I(M),A()}else m.value="Failed to create project. Please try again."}catch(r){const p=((e=(o=r.response)==null?void 0:o.data)==null?void 0:e.message)||((d=(l=r.response)==null?void 0:l.data)==null?void 0:d.exc)||"An error occurred while creating the project.";p.includes("Duplicate")||p.includes("already exists")?m.value="A project with this code already exists. Please use a unique project code.":m.value=p,console.error("Error creating project:",r)}finally{q.value=!1}},oe=async()=>{try{const e=(await w.get("/api/method/krcs_risk.krcs_risk_management.doctype.program_risk_register.api.get_departments")).data.message||[];F.value=e,O.value=e.flatMap(p=>p.units||[]);const l=await w.get("/api/resource/Project",{params:{fields:JSON.stringify(["name","project_name"]),limit_page_length:999}});R.value=l.data.data||[];const d=await w.get("/api/resource/Region",{params:{fields:JSON.stringify(["name","region_name"]),limit_page_length:999}});L.value=d.data.data||[];const r=await w.get("/api/method/krcs_risk.krcs_risk_management.doctype.program_risk_register.api.get_users");$.value=r.data.message||[]}catch(o){console.error("Failed to load master data",o)}},ae=async()=>{var o,e,l,d;P.value=!0,j.value="";try{const r=s.value.possible_causes.filter(f=>f.cause_description&&f.cause_description.trim()).map(f=>({doctype:"Possible Cause",cause_description:f.cause_description.trim()})),p=s.value.effects.filter(f=>f.consequence_description&&f.consequence_description.trim()).map(f=>({doctype:"Risk Consequence",consequence_description:f.consequence_description.trim()})),M={doctype:"Program Risk Register",project:s.value.project||null,department:s.value.department,unit:s.value.unit||null,region:s.value.region||null,risk_category:s.value.risk_category,risk_owner:s.value.risk_owner||null,risk_description:s.value.risk_description,possible_causes:r,effects:p,mitigating_actions:[],likelihood:s.value.likelihood,impact:s.value.impact,review_frequency:s.value.review_frequency||null,timeline:s.value.timeline||null,remarks:s.value.remarks||null,status:"Draft"},E=await w.post("/api/resource/Program Risk Register",M);E.data&&E.data.data?D.push(`/risk/${E.data.data.name}`):j.value="Failed to create risk. Please try again."}catch(r){j.value=((e=(o=r.response)==null?void 0:o.data)==null?void 0:e.message)||((d=(l=r.response)==null?void 0:l.data)==null?void 0:d.exc)||"An error occurred while creating the risk.",console.error("Error creating risk:",r)}finally{P.value=!1}};return ne(()=>{oe()}),(o,e)=>(a(),n("div",ue,[t("div",de,[t("button",{onClick:e[0]||(e[0]=l=>H(D).back()),class:"text-medium-gray hover:text-charcoal mb-4 flex items-center space-x-2"},[...e[18]||(e[18]=[t("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 19l-7-7 7-7"})],-1),t("span",null,"Back",-1)])]),e[19]||(e[19]=t("h1",{class:"text-3xl font-bold text-charcoal mb-2"},"Create New Risk",-1)),e[20]||(e[20]=t("p",{class:"text-medium-gray"},"Submit a new risk to the register",-1))]),t("form",{onSubmit:U(ae,["prevent"]),class:"space-y-6"},[t("div",ce,[e[33]||(e[33]=t("h2",{class:"card-header"},"Basic Information",-1)),t("div",pe,[t("div",me,[e[22]||(e[22]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Project",-1)),i(t("input",{"onUpdate:modelValue":e[1]||(e[1]=l=>C.value=l),onFocus:e[2]||(e[2]=l=>h.value=!0),onBlur:le,type:"text",class:"input w-full",placeholder:"Search or select project..."},null,544),[[v,C.value]]),h.value?(a(),n("div",ve,[t("button",{type:"button",onMousedown:U(se,["prevent"]),class:"w-full text-left px-4 py-2 text-sm hover:bg-light-gray flex items-center space-x-2 text-red-primary font-medium border-b border-light-border"},[...e[21]||(e[21]=[t("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),t("span",null,"Create New Project",-1)])],32),(a(!0),n(b,null,x(T.value,l=>(a(),n("button",{key:l.name,type:"button",onMousedown:U(d=>I(l),["prevent"]),class:"w-full text-left px-4 py-2 text-sm hover:bg-light-gray"},c(l.project_name),41,fe))),128)),T.value.length===0?(a(),n("div",be," No projects found ")):_("",!0)])):_("",!0)]),t("div",null,[e[24]||(e[24]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Department *",-1)),i(t("select",{"onUpdate:modelValue":e[3]||(e[3]=l=>s.value.department=l),required:"",class:"input w-full"},[e[23]||(e[23]=t("option",{value:""},"Select Department",-1)),(a(!0),n(b,null,x(F.value,l=>(a(),n("option",{key:l.name,value:l.name},c(l.department_name),9,xe))),128))],512),[[y,s.value.department]])]),t("div",null,[e[26]||(e[26]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Unit",-1)),i(t("select",{"onUpdate:modelValue":e[4]||(e[4]=l=>s.value.unit=l),class:"input w-full",disabled:!s.value.department},[e[25]||(e[25]=t("option",{value:""},"Select Unit",-1)),(a(!0),n(b,null,x(G.value,l=>(a(),n("option",{key:l.name,value:l.name},c(l.unit_name),9,ge))),128))],8,ke),[[y,s.value.unit]])]),t("div",null,[e[28]||(e[28]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Region",-1)),i(t("select",{"onUpdate:modelValue":e[5]||(e[5]=l=>s.value.region=l),class:"input w-full"},[e[27]||(e[27]=t("option",{value:""},"Select Region",-1)),(a(!0),n(b,null,x(L.value,l=>(a(),n("option",{key:l.name,value:l.name},c(l.region_name),9,ye))),128))],512),[[y,s.value.region]])]),t("div",null,[e[30]||(e[30]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Risk Category *",-1)),i(t("select",{"onUpdate:modelValue":e[6]||(e[6]=l=>s.value.risk_category=l),required:"",class:"input w-full"},[...e[29]||(e[29]=[z('<option value="">Select Category</option><option value="Financial">Financial</option><option value="Operational">Operational</option><option value="Strategic">Strategic</option><option value="Compliance">Compliance</option><option value="Reputational">Reputational</option><option value="Technology">Technology</option>',7)])],512),[[y,s.value.risk_category]])]),t("div",null,[e[32]||(e[32]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Risk Owner",-1)),i(t("select",{"onUpdate:modelValue":e[7]||(e[7]=l=>s.value.risk_owner=l),class:"input w-full"},[e[31]||(e[31]=t("option",{value:""},"Select Risk Owner",-1)),(a(!0),n(b,null,x($.value,l=>(a(),n("option",{key:l.name,value:l.name},c(l.full_name)+" ("+c(l.roles_display)+") ",9,we))),128))],512),[[y,s.value.risk_owner]])])])]),t("div",je,[e[35]||(e[35]=t("h2",{class:"card-header"},"Risk Description",-1)),t("div",null,[e[34]||(e[34]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Risk Description *",-1)),i(t("textarea",{"onUpdate:modelValue":e[8]||(e[8]=l=>s.value.risk_description=l),required:"",rows:"4",class:"input w-full",placeholder:"Describe the risk..."},null,512),[[v,s.value.risk_description]])])]),t("div",Ce,[t("div",{class:"flex items-center justify-between mb-4"},[e[37]||(e[37]=t("h2",{class:"text-lg font-bold text-charcoal"},"Possible Causes",-1)),t("button",{type:"button",onClick:Y,class:"btn btn-outline btn-sm"},[...e[36]||(e[36]=[t("svg",{class:"w-4 h-4 inline mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),K(" Add Cause ",-1)])])]),s.value.possible_causes.length===0?(a(),n("div",he,' No causes added yet. Click "Add Cause" to add one. ')):(a(),n("div",_e,[(a(!0),n(b,null,x(s.value.possible_causes,(l,d)=>(a(),n("div",{key:d,class:"flex gap-2"},[i(t("textarea",{"onUpdate:modelValue":r=>l.cause_description=r,rows:"2",class:"input w-full",placeholder:"Describe a possible cause..."},null,8,Pe),[[v,l.cause_description]]),t("button",{type:"button",onClick:r=>Z(d),class:"text-red-primary hover:text-red-600"},[...e[38]||(e[38]=[t("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])],8,Re)]))),128))]))]),t("div",qe,[t("div",{class:"flex items-center justify-between mb-4"},[e[40]||(e[40]=t("h2",{class:"text-lg font-bold text-charcoal"},"Effects / Consequences",-1)),t("button",{type:"button",onClick:ee,class:"btn btn-outline btn-sm"},[...e[39]||(e[39]=[t("svg",{class:"w-4 h-4 inline mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),K(" Add Effect ",-1)])])]),s.value.effects.length===0?(a(),n("div",Me,' No effects added yet. Click "Add Effect" to add one. ')):(a(),n("div",Ue,[(a(!0),n(b,null,x(s.value.effects,(l,d)=>(a(),n("div",{key:d,class:"flex gap-2"},[i(t("textarea",{"onUpdate:modelValue":r=>l.consequence_description=r,rows:"2",class:"input w-full",placeholder:"Describe a possible effect/consequence..."},null,8,Ve),[[v,l.consequence_description]]),t("button",{type:"button",onClick:r=>te(d),class:"text-red-primary hover:text-red-600"},[...e[41]||(e[41]=[t("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])],8,De)]))),128))]))]),t("div",Se,[e[47]||(e[47]=t("h2",{class:"card-header"},"Risk Assessment",-1)),t("div",Ne,[t("div",null,[e[42]||(e[42]=t("label",{class:"block text-sm font-medium text-charcoal mb-2"},"Likelihood (1-5) *",-1)),t("div",Ae,[i(t("input",{"onUpdate:modelValue":e[9]||(e[9]=l=>s.value.likelihood=l),type:"range",min:"1",max:"5",required:"",class:"flex-1"},null,512),[[v,s.value.likelihood,void 0,{number:!0}]]),t("span",Be,c(s.value.likelihood),1)]),e[43]||(e[43]=t("div",{class:"text-xs text-medium-gray mt-1"},"1 = Very Unlikely, 5 = Very Likely",-1))]),t("div",null,[e[44]||(e[44]=t("label",{class:"block text-sm font-medium text-charcoal mb-2"},"Impact (1-5) *",-1)),t("div",Ee,[i(t("input",{"onUpdate:modelValue":e[10]||(e[10]=l=>s.value.impact=l),type:"range",min:"1",max:"5",required:"",class:"flex-1"},null,512),[[v,s.value.impact,void 0,{number:!0}]]),t("span",Fe,c(s.value.impact),1)]),e[45]||(e[45]=t("div",{class:"text-xs text-medium-gray mt-1"},"1 = Negligible, 5 = Catastrophic",-1))]),t("div",Le,[e[46]||(e[46]=t("div",{class:"text-sm text-medium-gray mb-1"},"Overall Rating (Auto-calculated)",-1)),t("div",{class:re(["text-3xl font-bold",X(N.value)])},c(N.value)+" â€” "+c(W.value),3)])])]),t("div",Oe,[e[51]||(e[51]=t("h2",{class:"card-header"},"Review Schedule",-1)),t("div",$e,[t("div",null,[e[49]||(e[49]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Review Frequency",-1)),i(t("select",{"onUpdate:modelValue":e[11]||(e[11]=l=>s.value.review_frequency=l),class:"input w-full"},[...e[48]||(e[48]=[z('<option value="">Not Scheduled</option><option value="Daily">Daily</option><option value="Weekly">Weekly</option><option value="Fortnightly">Fortnightly</option><option value="Monthly">Monthly</option><option value="Quarterly">Quarterly</option><option value="Semi-Annual">Semi-Annual</option><option value="Annual">Annual</option>',8)])],512),[[y,s.value.review_frequency]])]),t("div",null,[e[50]||(e[50]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Timeline",-1)),i(t("input",{"onUpdate:modelValue":e[12]||(e[12]=l=>s.value.timeline=l),type:"text",class:"input w-full",placeholder:"e.g., Q1 2026"},null,512),[[v,s.value.timeline]])])])]),t("div",Te,[e[53]||(e[53]=t("h2",{class:"card-header"},"Additional Information",-1)),t("div",null,[e[52]||(e[52]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Remarks",-1)),i(t("textarea",{"onUpdate:modelValue":e[13]||(e[13]=l=>s.value.remarks=l),rows:"2",class:"input w-full",placeholder:"Any additional notes..."},null,512),[[v,s.value.remarks]])])]),j.value?(a(),n("div",Ie,[t("p",He,c(j.value),1)])):_("",!0),t("div",ze,[t("button",{type:"button",onClick:e[14]||(e[14]=l=>H(D).back()),class:"btn btn-outline"},"Cancel"),t("button",{type:"submit",disabled:P.value,class:"btn btn-primary"},c(P.value?"Creating...":"Create Risk"),9,Ke)])],32),S.value?(a(),n("div",{key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:A},[t("div",{class:"bg-white rounded-lg shadow-xl max-w-md w-full mx-4",onClick:e[17]||(e[17]=U(()=>{},["stop"]))},[e[57]||(e[57]=t("div",{class:"px-6 py-4 border-b border-light-border"},[t("h3",{class:"text-xl font-bold text-charcoal"},"Create New Project")],-1)),t("div",Qe,[t("div",null,[e[54]||(e[54]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Project Name *",-1)),i(t("input",{"onUpdate:modelValue":e[15]||(e[15]=l=>k.value=l),type:"text",class:"input w-full",placeholder:"Enter project name",onKeydown:Q(B,["enter"])},null,544),[[v,k.value]])]),t("div",null,[e[55]||(e[55]=t("label",{class:"block text-sm font-medium text-charcoal mb-1"},"Project Code (ID) *",-1)),i(t("input",{"onUpdate:modelValue":e[16]||(e[16]=l=>g.value=l),type:"text",class:"input w-full",placeholder:"Unique project code/ID",onKeydown:Q(B,["enter"])},null,544),[[v,g.value]]),e[56]||(e[56]=t("p",{class:"text-xs text-medium-gray mt-1"},"Must be unique identifier for this project",-1))]),m.value?(a(),n("div",Je,[t("p",We,c(m.value),1)])):_("",!0)]),t("div",Ge,[t("button",{type:"button",onClick:A,class:"btn btn-outline"},"Cancel"),t("button",{type:"button",onClick:B,disabled:q.value,class:"btn btn-primary"},c(q.value?"Creating...":"Create Project"),9,Xe)])])])):_("",!0)]))}};export{tt as default};
